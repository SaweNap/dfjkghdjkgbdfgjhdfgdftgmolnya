<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Игры: Баланс и Молния</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-image: url('https://github.com/SaweNap/dfjkghdjkgbdfgjhdfgdftgmolnya/raw/main/fon.jpg');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    color: #fff;
    margin: 0;
    padding: 20px;
  }

  .balance {
    font-size: 1.5em;
    margin-bottom: 20px;
    text-shadow: 1px 1px 2px #000;
    text-align: center;
  }

  h1 {
    margin-bottom: 10px;
    font-size: 2em;
    text-align: center;
    text-shadow: 1px 1px 3px #000;
  }

  #game-container {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    max-width: 600px;
    margin: 0 auto 30px;
    position: relative;
  }

  .cell {
    width: 100px;
    height: 100px;
    margin: 10px;
    background: #555;
    border-radius: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    transition: transform 0.2s, background 0.3s, box-shadow 0.3s, outline 0.2s;
    position: relative;
  }
  .cell:hover {
    background: #777;
    transform: scale(1.05);
    box-shadow: 0 6px 12px rgba(0,0,0,0.4);
  }
  .cell.active {
    outline: 3px solid yellow;
  }
  .cell.molnia {
    outline: 3px solid red;
  }
  .lightning {
    position: absolute;
    width: 40px;
    height: 50px;
    background: linear-gradient(135deg, #ffff00, #ffcc00);
    clip-path: polygon(50% 0%, 60% 20%, 80% 20%, 55% 50%, 70% 50%, 30% 100%, 45% 50%, 20% 50%, 45% 0%);
    opacity: 1;
    animation: lightning-flicker 0.15s infinite;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
  }
  @keyframes lightning-flicker {
    0%, 100% { opacity: 1; filter: brightness(1); }
    50% { opacity: 0.4; filter: brightness(2); }
  }

  #result {
    margin-top: 20px;
    font-size: 1.4em;
    text-align: center;
    min-height: 40px;
  }

  #start-game-btn {
    display: block;
    margin: 20px auto;
    padding: 15px 40px;
    font-size: 1.2em;
    background: linear-gradient(135deg, #00c3ff, #005aa7);
    border: none;
    border-radius: 25px;
    color: #fff;
    cursor: pointer;
    box-shadow: 0 8px 15px rgba(0,0,0,0.3);
    transition: all 0.3s ease, transform 0.2s;
  }
  #start-game-btn:hover {
    background: linear-gradient(135deg, #00eaff, #0072d3);
    transform: scale(1.05);
    box-shadow: 0 12px 20px rgba(0,0,0,0.4);
  }
  #start-game-btn:active {
    transform: scale(0.98);
  }

  #bet-input {
    display: block;
    margin: 0 auto 10px;
    padding: 12px 20px;
    font-size: 1.2em;
    border-radius: 20px;
    border: none;
    outline: none;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    width: 200px;
  }

  #message {
    text-align: center;
    margin-top: 10px;
    font-size: 1em;
    min-height: 20px;
  }

  #overlayMessage {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    color: #fff;
    font-size: 1.5em;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    padding: 20px;
    text-align: center;
    display: none;
  }
</style>
</head>
<body>

<div id="overlayMessage"></div>

<div class="balance" id="balanceDisplay">Баланс: 0 ₽</div>
<input type="number" id="bet-input" placeholder="Введите ставку" min="1" />

<button id="start-game-btn">Начать игру</button>
<p id="message"></p>
<div id="result"></div>

<p style="text-align:center;">Выберите ячейку и нажмите "Начать игру"</p>

<div id="game-container" style="position: relative;"></div>
<div id="lightning-effect"></div>

<script>
const GITHUB_TOKEN = 'ВАШ_ТОКЕН_ЗДЕСЬ'; // вставьте сюда свой токен
const GITHUB_REPO = 'SaweNap/dfjghdfifgJSON';
const FILE_PATH = 'users.json';

const balanceDisplay = document.getElementById('balanceDisplay');
const messageEl = document.getElementById('message');
const betInput = document.getElementById('bet-input');
const startGameBtn = document.getElementById('start-game-btn');
const gameContainer = document.getElementById('game-container');
const lightningDiv = document.getElementById('lightning-effect');
const resultDiv = document.getElementById('result');

let userId = null;
let users = [];
let userBalance = 0;
let currentUser = null;
let selectedCellIndex = null;
let lightningIndex = null;
let gameInProgress = false;

// Создаем ячейки
for (let i = 0; i < 9; i++) {
  const cell = document.createElement('div');
  cell.className = 'cell';
  cell.textContent = i + 1;
  cell.dataset.index = i;
  cell.onclick = () => {
    if (gameInProgress) return; // чтобы не мешать во время игры
    document.querySelectorAll('.cell').forEach(c => c.classList.remove('active', 'molnia'));
    cell.classList.add('active');
    selectedCellIndex = i;
  };
  gameContainer.appendChild(cell);
}

// Инициализация
(async () => {
  const params = new URLSearchParams(window.location.search);
  userId = params.get('id') || 'test';
  await loadUsers();
  currentUser = users.find(u => u.id.toString() === userId.toString());
  if (currentUser) {
    userBalance = currentUser.balance || 0;
    updateBalanceDisplay(userBalance);
    checkButtonState();
  } else {
    updateBalanceDisplay(0);
    checkButtonState();
    showOverlayMessage('Пользователь не найден!');
  }
})();

function updateBalanceDisplay(balance) {
  document.getElementById('balanceDisplay').textContent = 'Баланс: ' + balance + ' ₽';
}

function checkButtonState() {
  startGameBtn.disabled = !(userBalance > 0 && currentUser);
  if (userBalance <= 0 || !currentUser) {
    messageEl.textContent = 'Баланс 0 или пользователь не загружен.';
  } else {
    messageEl.textContent = '';
  }
}

function showOverlayMessage(text) {
  const overlay = document.getElementById('overlayMessage');
  overlay.innerHTML = text;
  overlay.style.display = 'flex';
  setTimeout(() => {
    overlay.style.display = 'none';
  }, 2000);
}

document.getElementById('start-game-btn').onclick = () => {
  if (!currentUser) {
    showOverlayMessage('Пользователь не загружен');
    return;
  }
  const bet = parseFloat(betInput.value);
  if (isNaN(bet) || bet <= 0) {
    showOverlayMessage('Введите корректную ставку');
    return;
  }
  if (userBalance < bet) {
    showOverlayMessage('Баланс недостаточен!');
    return;
  }
  startGame(bet);
};

async function startGame(bet) {
  if (selectedCellIndex === null) {
    showOverlayMessage('Пожалуйста, выберите ячейку');
    return;
  }
  gameInProgress = true;
  resultDiv.textContent = '';

  document.querySelectorAll('.cell').forEach(c => {
    c.classList.remove('active', 'molnia');
    c.style.outline = '';
    const lightningElems = c.querySelectorAll('.lightning');
    lightningElems.forEach(le => le.remove());
  });

  // выбираем молнию
  lightningIndex = Math.floor(Math.random() * 9);
  showLightning(lightningIndex);

  setTimeout(async () => {
    const cells = document.querySelectorAll('.cell');

    // подсветка ячейки с молнией
    cells[lightningIndex].classList.add('molnia');

    // подсветка выбранной ячейки
    if (selectedCellIndex !== null) {
      cells[selectedCellIndex].classList.add('active');
    }

    if (lightningIndex === selectedCellIndex) {
      // выигрыш
      resultDiv.textContent = 'Вы выиграли!';
      userBalance += bet * 3; // умножение x3
    } else {
      // проигрыш
      resultDiv.textContent = `Молния была в ячейке ${lightningIndex + 1}. Вы проиграли.`;
    }

    // Обновляем баланс и сохраняем
    currentUser.balance = userBalance;
    await saveUserBalance();

    updateBalanceDisplay(userBalance);
    // очищаем ячейки
    document.querySelectorAll('.cell').forEach(c => {
      c.classList.remove('active', 'molnia');
      const lightningElems = c.querySelectorAll('.lightning');
      lightningElems.forEach(le => le.remove());
    });
    selectedCellIndex = null;
    gameInProgress = false;
  }, 1500);
}

function showLightning(index) {
  const cells = document.querySelectorAll('.cell');
  if (cells[index]) {
    const bolt = document.createElement('div');
    bolt.className = 'lightning';
    cells[index].appendChild(bolt);
  }
}

// Загрузка пользователей
async function loadUsers() {
  const url = `https://raw.githubusercontent.com/${GITHUB_REPO}/main/${FILE_PATH}`;
  const response = await fetch(url);
  if (response.ok) {
    users = await response.json();
  } else {
    users = [];
  }
}

// Сохранение баланса
async function saveUserBalance() {
  await loadUsers();
  const idx = users.findIndex(u => u.id.toString() === userId.toString());
  if (idx >= 0) {
    users[idx].balance = userBalance;
  } else {
    users.push({ id: userId, nickname: '', balance: userBalance });
  }
  await updateUsersOnGitHub();
}

// Обновление файла на GitHub
async function updateUsersOnGitHub() {
  const url = `https://api.github.com/repos/${GITHUB_REPO}/contents/${FILE_PATH}`;
  const getRes = await fetch(url, {
    headers: {
      'Authorization': 'token ' + GITHUB_TOKEN,
      'Accept': 'application/vnd.github.v3+json'
    }
  });
  if (!getRes.ok) { showOverlayMessage('Ошибка получения файла'); return; }
  const sha = (await getRes.json()).sha;
  const contentBase64 = btoa(JSON.stringify(users, null, 2));
  const payload = {
    message: 'Обновление баланса пользователя',
    content: contentBase64,
    sha: sha
  };
  await fetch(url, {
    method: 'PUT',
    headers: {
      'Authorization': 'token ' + GITHUB_TOKEN,
      'Accept': 'application/vnd.github.v3+json'
    },
    body: JSON.stringify(payload)
  });
}
</script>
</body>
</html>
