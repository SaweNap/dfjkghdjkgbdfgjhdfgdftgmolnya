<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Игры: Баланс и Молния</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: linear-gradient(135deg, #1e3c72, #2a5298);
    color: #fff;
    margin: 0;
    padding: 20px;
  }

  .balance {
    font-size: 1.5em;
    margin-bottom: 20px;
    text-shadow: 1px 1px 2px #000;
  }

  /* Стиль для игры Молния */
  h1 {
    margin-bottom: 10px;
  }

  #game-container {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    max-width: 600px;
    margin: 0 auto 30px;
  }

  .cell {
    width: 100px;
    height: 100px;
    margin: 10px;
    background: #555;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    cursor: pointer;
    transition: background 0.3s;
  }

  .cell:hover {
    background: #777;
  }

  .active {
    background: yellow;
  }

  #result {
    margin-top: 20px;
    font-size: 20px;
  }

  #play-btn, #start-game-btn {
    margin-top: 20px;
    padding: 10px 20px;
    font-size: 18px;
    cursor: pointer;
  }
</style>
</head>
<body>

<div class="balance" id="balanceDisplay">Баланс: 0 ₽</div>
<input type="number" id="bet-input" placeholder="Введите ставку" min="1" />
<button id="start-game-btn">Начать игру</button>
<p id="message"></p>

<h1>Игра Молния</h1>
<p>Выберите ячейку и нажмите "Старт"</p>

<div id="game-container">
  <!-- ячейки создаются динамически -->
</div>

<button id="play-btn">Старт</button>
<div id="result"></div>

<script>
const GITHUB_TOKEN = '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'; // вставьте сюда ваш токен
const GITHUB_REPO = 'SaweNap/dfjghdfifgJSON';
const FILE_PATH = 'users.json';

const balanceDisplay = document.getElementById('balanceDisplay');
const messageEl = document.getElementById('message');
const betInput = document.getElementById('bet-input');
const startGameBtn = document.getElementById('start-game-btn');

let userId = null;
let users = [];
let userBalance = 0;
let currentUser = null;
let selectedCellIndex = null;
let lightningIndex = null;
let gameInProgress = false;

// Создаем ячейки
const container = document.getElementById('game-container');
for (let i = 0; i < 9; i++) {
  const cell = document.createElement('div');
  cell.className = 'cell';
  cell.textContent = i + 1;
  cell.dataset.index = i;
  cell.onclick = () => {
    if (gameInProgress) return;
    document.querySelectorAll('.cell').forEach(c => c.classList.remove('active'));
    cell.classList.add('active');
    selectedCellIndex = i;
  };
  container.appendChild(cell);
}

// Получение userId из URL и загрузка данных
(function() {
  const urlParams = new URLSearchParams(window.location.search);
  userId = urlParams.get('id');
  if (userId) {
    loadUsers().then(() => {
      currentUser = users.find(u => u.id.toString() === userId.toString());
      if (currentUser) {
        userBalance = currentUser.balance || 0;
        updateBalanceDisplay(userBalance);
        checkButtonState();
      } else {
        // Пользователь не найден
        updateBalanceDisplay(0);
        checkButtonState();
        messageEl.textContent = 'Пользователь не найден!';
      }
    });
  } else {
    updateBalanceDisplay(0);
    checkButtonState();
    messageEl.textContent = 'Пользователь не загружен!';
  }
})();

function updateBalanceDisplay(balance) {
  balanceDisplay.textContent = 'Баланс: ' + balance + ' ₽';
}

function checkButtonState() {
  if (userBalance <= 0 || !currentUser) {
    document.getElementById('start-game-btn').disabled = true;
    if (!currentUser) {
      messageEl.textContent = 'Пользователь не найден!';
    } else {
      messageEl.textContent = 'Баланс 0 или пользователь не загружен.';
    }
  } else {
    document.getElementById('start-game-btn').disabled = false;
    messageEl.textContent = '';
  }
}

document.getElementById('start-game-btn').onclick = () => {
  if (!currentUser) {
    alert('Пользователь не загружен');
    return;
  }
  const bet = parseFloat(betInput.value);
  if (isNaN(bet) || bet <= 0) {
    alert('Введите корректную ставку');
    return;
  }
  if (userBalance < bet) {
    alert('Баланс недостаточен!');
    return;
  }
  startGame(bet);
};

async function startGame(bet) {
  if (selectedCellIndex === null) {
    alert('Пожалуйста, выберите ячейку');
    return;
  }
  gameInProgress = true;
  document.getElementById('result').textContent = '';

  // Выбираем молнию
  lightningIndex = Math.floor(Math.random() * 9);

  // Показываем молнию
  setTimeout(() => {
    document.querySelectorAll('.cell')[lightningIndex].classList.add('active');

    setTimeout(() => {
      const guessCorrect = lightningIndex === selectedCellIndex;
      if (guessCorrect) {
        document.getElementById('result').textContent = 'Поздравляем! Вы угадали!';
        userBalance += bet * 2;
      } else {
        document.getElementById('result').textContent = `Молния была в ячейке ${lightningIndex + 1}. Попробуйте еще раз!`;
        userBalance -= bet;
        if (userBalance < 0) userBalance = 0;
      }
      updateBalanceDisplay(userBalance);
      currentUser.balance = userBalance;
      saveUserBalance();

      document.querySelectorAll('.cell').forEach(c => c.classList.remove('active'));
      gameInProgress = false;
    }, 1000);
  }, Math.random() * 1000 + 1000);
}

// Загрузка пользователей с GitHub
async function loadUsers() {
  const url = `https://raw.githubusercontent.com/${GITHUB_REPO}/main/${FILE_PATH}`;
  const response = await fetch(url);
  if (response.ok) {
    users = await response.json();
  } else {
    users = [];
  }
}

// Обновление файла users.json на GitHub
async function saveUserBalance() {
  await loadUsers();
  const idx = users.findIndex(u => u.id.toString() === userId.toString());
  if (idx >= 0) {
    users[idx].balance = userBalance;
  } else {
    users.push({ id: userId, nickname: '', balance: userBalance });
  }
  await updateUsersOnGitHub();
}

async function updateUsersOnGitHub() {
  const url = `https://api.github.com/repos/${GITHUB_REPO}/contents/${FILE_PATH}`;
  const getRes = await fetch(url, {
    headers: {
      'Authorization': 'token ' + GITHUB_TOKEN,
      'Accept': 'application/vnd.github.v3+json'
    }
  });
  if (!getRes.ok) {
    alert('Ошибка получения файла для обновления');
    return;
  }
  const sha = (await getRes.json()).sha;
  const contentBase64 = btoa(JSON.stringify(users, null, 2));
  const payload = {
    message: 'Обновление баланса пользователя',
    content: contentBase64,
    sha: sha
  };
  const putRes = await fetch(url, {
    method: 'PUT',
    headers: {
      'Authorization': 'token ' + GITHUB_TOKEN,
      'Accept': 'application/vnd.github.v3+json'
    },
    body: JSON.stringify(payload)
  });
  if (!putRes.ok) {
    alert('Ошибка при обновлении файла на GitHub');
  }
}
</script>
</body>
</html>
