<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Игры: Баланс и Молния</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #1e3c72, #2a5298);
    color: #fff;
    margin: 0;
    padding: 20px;
  }

  .balance {
    font-size: 1.5em;
    margin-bottom: 20px;
    text-shadow: 1px 1px 2px #000;
    text-align: center;
  }

  h1 {
    margin-bottom: 10px;
    font-size: 2em;
    text-align: center;
    text-shadow: 1px 1px 3px #000;
  }

  #game-container {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    max-width: 600px;
    margin: 0 auto 30px;
    position: relative;
  }

  .cell {
    width: 100px;
    height: 100px;
    margin: 10px;
    background: #555;
    border-radius: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    transition: transform 0.2s, background 0.3s, box-shadow 0.3s;
  }

  .cell:hover {
    background: #777;
    transform: scale(1.05);
    box-shadow: 0 6px 12px rgba(0,0,0,0.4);
  }

  /* Анимация молнии */
  @keyframes lightning-flicker {
    0%, 100% { opacity: 1; filter: brightness(1); }
    50% { opacity: 0.4; filter: brightness(2); }
  }

  .lightning {
    position: absolute;
    width: 50px;
    height: 150px;
    background: linear-gradient(135deg, #ffff00, #ffcc00);
    clip-path: polygon(50% 0%, 60% 20%, 80% 20%, 55% 50%, 70% 50%, 30% 100%, 45% 50%, 20% 50%, 45% 0%);
    opacity: 1;
    animation: lightning-flicker 0.15s infinite;
    z-index: 10;
    pointer-events: none;
  }

  /* Молния с эффектом свечения */
  #lightning-effect {
    position: absolute;
    width: 80px;
    height: 300px;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    background: transparent;
    pointer-events: none;
    display: none;
    z-index: 9;
  }

  #lightning-effect.show {
    display: block;
    animation: lightning-shine 0.2s forwards;
  }

  @keyframes lightning-shine {
    0% { opacity: 0; filter: blur(4px); }
    50% { opacity: 1; filter: blur(2px); }
    100% { opacity: 0; filter: blur(0); }
  }

  #result {
    margin-top: 20px;
    font-size: 1.4em;
    text-align: center;
    min-height: 40px;
  }

  #start-game-btn {
    display: block;
    margin: 20px auto;
    padding: 15px 40px;
    font-size: 1.2em;
    background: linear-gradient(135deg, #00c3ff, #005aa7);
    border: none;
    border-radius: 25px;
    color: #fff;
    cursor: pointer;
    box-shadow: 0 8px 15px rgba(0,0,0,0.3);
    transition: all 0.3s ease, transform 0.2s;
  }

  #start-game-btn:hover {
    background: linear-gradient(135deg, #00eaff, #0072d3);
    transform: scale(1.05);
    box-shadow: 0 12px 20px rgba(0,0,0,0.4);
  }

  #start-game-btn:active {
    transform: scale(0.98);
  }

  #bet-input {
    display: block;
    margin: 0 auto 10px;
    padding: 12px 20px;
    font-size: 1.2em;
    border-radius: 20px;
    border: none;
    outline: none;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    width: 200px;
  }

  #message {
    text-align: center;
    margin-top: 10px;
    font-size: 1em;
    min-height: 20px;
  }
</style>
</head>
<body>

<div class="balance" id="balanceDisplay">Баланс: 0 ₽</div>
<input type="number" id="bet-input" placeholder="Введите ставку" min="1" />

<!-- Кнопка "Начать игру" -->
<button id="start-game-btn">Начать игру</button>
<p id="message"></p>

<h1>Игра Молния</h1>
<p style="text-align:center;">Выберите ячейку и нажмите "Начать игру"</p>

<div id="game-container" style="position: relative;">
  <!-- ячейки создаются динамически -->
</div>

<!-- Молния с эффектом -->
<div id="lightning-effect"></div>

<script>
const GITHUB_TOKEN = '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'; // ваш токен
const GITHUB_REPO = 'SaweNap/dfjghdfifgJSON';
const FILE_PATH = 'users.json';

const balanceDisplay = document.getElementById('balanceDisplay');
const messageEl = document.getElementById('message');
const betInput = document.getElementById('bet-input');
const startGameBtn = document.getElementById('start-game-btn');
const gameContainer = document.getElementById('game-container');
const lightningDiv = document.getElementById('lightning-effect');

let userId = null;
let users = [];
let userBalance = 0;
let currentUser = null;
let selectedCellIndex = null;
let lightningIndex = null;
let gameInProgress = false;

// Создаем ячейки
for (let i = 0; i < 9; i++) {
  const cell = document.createElement('div');
  cell.className = 'cell';
  cell.textContent = i + 1;
  cell.dataset.index = i;
  cell.onclick = () => {
    // Можно выбрать ячейку даже во время игры
    document.querySelectorAll('.cell').forEach(c => c.classList.remove('active'));
    cell.classList.add('active');
    selectedCellIndex = i;
  };
  gameContainer.appendChild(cell);
}

// Запрет ctrl + колесо мыши
window.addEventListener('wheel', (e) => {
  if (e.ctrlKey) {
    e.preventDefault();
  }
}, { passive: false });

// загрузка userId и данных
(function() {
  const urlParams = new URLSearchParams(window.location.search);
  userId = urlParams.get('id');
  if (userId) {
    loadUsers().then(() => {
      currentUser = users.find(u => u.id.toString() === userId.toString());
      if (currentUser) {
        userBalance = currentUser.balance || 0;
        updateBalanceDisplay(userBalance);
        checkButtonState();
      } else {
        updateBalanceDisplay(0);
        checkButtonState();
        messageEl.textContent = 'Пользователь не найден!';
      }
    });
  } else {
    updateBalanceDisplay(0);
    checkButtonState();
    messageEl.textContent = 'Пользователь не загружен!';
  }
})();

function updateBalanceDisplay(balance) {
  balanceDisplay.textContent = 'Баланс: ' + balance + ' ₽';
}

function checkButtonState() {
  if (userBalance <= 0 || !currentUser) {
    startGameBtn.disabled = true;
    if (!currentUser) {
      messageEl.textContent = 'Пользователь не найден!';
    } else {
      messageEl.textContent = 'Баланс 0 или пользователь не загружен.';
    }
  } else {
    startGameBtn.disabled = false;
    messageEl.textContent = '';
  }
}

document.getElementById('start-game-btn').onclick = () => {
  if (!currentUser) {
    alert('Пользователь не загружен');
    return;
  }
  const bet = parseFloat(betInput.value);
  if (isNaN(bet) || bet <= 0) {
    alert('Введите корректную ставку');
    return;
  }
  if (userBalance < bet) {
    alert('Баланс недостаточен!');
    return;
  }
  startGame(bet);
};

async function startGame(bet) {
  if (selectedCellIndex === null) {
    alert('Пожалуйста, выберите ячейку');
    return;
  }
  gameInProgress = true;
  document.getElementById('result').textContent = '';

  // выбираем молнию
  lightningIndex = Math.floor(Math.random() * 9);
  
  // показываем молнию с анимацией
  showLightning();

  setTimeout(() => {
    document.querySelectorAll('.cell')[lightningIndex].classList.add('active');

    setTimeout(() => {
      const guessCorrect = lightningIndex === selectedCellIndex;
      if (guessCorrect) {
        document.getElementById('result').textContent = 'Поздравляем! Вы угадали!';
        userBalance += bet * 2;
      } else {
        document.getElementById('result').textContent = `Молния была в ячейке ${lightningIndex + 1}. Попробуйте еще раз!`;
        userBalance -= bet;
        if (userBalance < 0) userBalance = 0;
      }
      updateBalanceDisplay(userBalance);
      currentUser.balance = userBalance;
      saveUserBalance();

      document.querySelectorAll('.cell').forEach(c => c.classList.remove('active'));
      
      // После завершения игры сбрасываем выбранную ячейку
      selectedCellIndex = null;
      
      gameInProgress = false;
    }, 1000);
  }, Math.random() * 1000 + 1000);
}

// Функция для анимации молнии
function showLightning() {
  lightningDiv.innerHTML = '';
  lightningDiv.style.display = 'block';

  const lightning = document.createElement('div');
  lightning.className = 'lightning';

  // Создаем мерцания
  for (let i = 0; i < 3; i++) {
    const flicker = document.createElement('div');
    flicker.style.position = 'absolute';
    flicker.style.width = '100%';
    flicker.style.height = '100%';
    flicker.style.background = 'linear-gradient(135deg, #ffff00, #ffcc00)';
    flicker.style.mixBlendMode = 'screen';
    flicker.style.opacity = Math.random() * 0.8 + 0.2;
    flicker.style.transform = `rotate(${Math.random() * 10 - 5}deg)`;
    flicker.style.filter = `blur(${Math.random() * 2 + 1}px)`;
    lightning.appendChild(flicker);
  }

  lightningDiv.appendChild(lightning);
  lightning.style.animation = 'flicker 0.2s infinite';

  // Удаляем эффект через короткое время
  setTimeout(() => {
    lightningDiv.classList.remove('show');
    lightning.innerHTML = '';
    lightningDiv.style.display = 'none';
  }, 300);
}

// Анимация мерцания молнии
const styleSheet = document.styleSheets[0];
styleSheet.insertRule(`
@keyframes flicker {
  0%, 100% { opacity: 1; filter: brightness(1); }
  50% { opacity: 0.4; filter: brightness(2); }
}
`, styleSheet.cssRules.length);

// Загрузка и сохранение данных
async function loadUsers() {
  const url = `https://raw.githubusercontent.com/${GITHUB_REPO}/main/${FILE_PATH}`;
  const response = await fetch(url);
  if (response.ok) {
    users = await response.json();
  } else {
    users = [];
  }
}

async function saveUserBalance() {
  await loadUsers();
  const idx = users.findIndex(u => u.id.toString() === userId.toString());
  if (idx >= 0) {
    users[idx].balance = userBalance;
  } else {
    users.push({ id: userId, nickname: '', balance: userBalance });
  }
  await updateUsersOnGitHub();
}

async function updateUsersOnGitHub() {
  const url = `https://api.github.com/repos/${GITHUB_REPO}/contents/${FILE_PATH}`;
  const getRes = await fetch(url, {
    headers: {
      'Authorization': 'token ' + GITHUB_TOKEN,
      'Accept': 'application/vnd.github.v3+json'
    }
  });
  if (!getRes.ok) { alert('Ошибка получения файла для обновления'); return; }
  const sha = (await getRes.json()).sha;
  const contentBase64 = btoa(JSON.stringify(users, null, 2));
  const payload = {
    message: 'Обновление баланса пользователя',
    content: contentBase64,
    sha: sha
  };
  await fetch(url, {
    method: 'PUT',
    headers: {
      'Authorization': 'token ' + GITHUB_TOKEN,
      'Accept': 'application/vnd.github.v3+json'
    },
    body: JSON.stringify(payload)
  });
}
</script>
</body>
</html>
